@using StudentSystem.Client.Pages
@using StudentSystem.Client.Services.AuthServices
@using StudentSystem.Client.Services.UserServices
@using Microsoft.AspNetCore.SignalR.Client;

@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager _navigationManager
@inject ISnackbar _snackbar
@inject IJSRuntime _jsRuntime
@inject IClientUserService ClientUserService
@inject IClientAuthService ClientAuthService
@inherits LayoutComponentBase
    
@rendermode InteractiveWebAssembly

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <MudSpacer />
        <LoginLogoutButton />
    </MudAppBar>
    <MudDrawer @bind-Open="@open" Elevation="1">
        <MudDrawerHeader>
            <NavMenu/>
        </MudDrawerHeader>
    </MudDrawer>
    <MudMainContent Class="pt-16 px-16 mt-4" >
        <CascadingValue Value="hubConnection">
            @Body
        </CascadingValue>
    </MudMainContent>
</MudLayout>

<audio id="notification" src="/media/Messenger Notification Sound Effect.mp3" />

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@code {
    bool open = false;

    void ToggleDrawer()
    {
        open = !open;
    }

    private string CurrentUserId { get; set; }
    private HubConnection hubConnection;

    public bool IsConnected => hubConnection.State == HubConnectionState.Connected;

    protected override async Task OnInitializedAsync()
    {

        CurrentUserId = await ClientUserService.GetUserId();

        hubConnection = new HubConnectionBuilder().WithUrl(_navigationManager.ToAbsoluteUri("/chat-hub")).Build();

        await hubConnection.StartAsync();

        hubConnection.On<string, int, string>("ReceiveChatNotification", (message, receiverUserId, senderUserId) =>
        {
            if (CurrentUserId == receiverUserId.ToString())
            {
                _jsRuntime.InvokeAsync<string>("PlayAudio", "notification");
                _snackbar.Add(message, Severity.Info, config =>
                {
                    config.VisibleStateDuration = 10000;
                    config.HideTransitionDuration = 500;
                    config.ShowTransitionDuration = 500;
                    config.Action = "Chat?";
                    config.ActionColor = Color.Info;
                    config.Onclick = snackbar => 
                    {
                        _navigationManager.NavigateTo($"chat/{senderUserId}");
                        return Task.CompletedTask;
                    };

                });
            }
        });
    }

    
}